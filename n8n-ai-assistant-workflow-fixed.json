{
  "name": "AIé¡¹ç›®åŠ©æ‰‹å·¥ä½œæµ",
  "nodes": [
    {
      "parameters": {
        "path": "/webhook",
        "responseMode": "responseNode"
      },
      "id": "1",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "ai-assistant-webhook"
    },
    {
      "parameters": {
        "jsCode": "// å¢å¼ºè°ƒè¯•å’Œé”™è¯¯å¤„ç†\nconsole.log('=== è§£æç”¨æˆ·è¾“å…¥èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œ ===');\nconsole.log('å®Œæ•´è¾“å…¥å¯¹è±¡:', JSON.stringify($input, null, 2));\n\n// æ£€æŸ¥è¾“å…¥æ˜¯å¦å­˜åœ¨\nif (!$input || !$input.first) {\n  throw new Error('è¾“å…¥æ•°æ®æ ¼å¼é”™è¯¯ï¼š$input æˆ– $input.first ä¸å­˜åœ¨');\n}\n\nconst firstInput = $input.first();\nconsole.log('ç¬¬ä¸€ä¸ªè¾“å…¥é¡¹:', JSON.stringify(firstInput, null, 2));\n\n// æ£€æŸ¥è¾“å…¥é¡¹æ˜¯å¦åŒ…å«jsonæ•°æ®\nif (!firstInput || !firstInput.json) {\n  console.log('è¾“å…¥æ•°æ®ç»“æ„:', {\n    hasJson: !!firstInput?.json,\n    jsonType: typeof firstInput?.json,\n    jsonValue: firstInput?.json\n  });\n  throw new Error('è¾“å…¥æ•°æ®æ ¼å¼é”™è¯¯ï¼šè¯·ç¡®ä¿è¯·æ±‚åŒ…å«æœ‰æ•ˆçš„JSONæ•°æ®ï¼Œæ ¼å¼ä¸º {\\\"userId\\\": \\\"...\\\", \\\"message\\\": \\\"...\\\"}');\n}\n\nconst inputData = firstInput.json;\nconsole.log('è§£æåˆ°çš„JSONæ•°æ®:', JSON.stringify(inputData, null, 2));\n\n// æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆå¯¹è±¡\nif (typeof inputData !== 'object' || inputData === null) {\n  throw new Error('JSONæ•°æ®æ ¼å¼é”™è¯¯ï¼šæœŸæœ›å¯¹è±¡ç±»å‹ï¼Œå®é™…ä¸º ' + typeof inputData);\n}\n\n// è§£æ„å‚æ•°å¹¶æä¾›é»˜è®¤å€¼\nconst { \n  userId = '', \n  message = '', \n  sessionId = `session_${Date.now()}` \n} = inputData;\n\nconsole.log('è§£æ„åçš„å‚æ•°:', { userId, message, sessionId });\n\n// éªŒè¯å¿…è¦å‚æ•°\nif (!userId && !message) {\n  throw new Error('ç¼ºå°‘å¿…è¦å‚æ•°ï¼šuserId å’Œ message éƒ½æœªæä¾›ã€‚è¯·æ£€æŸ¥è¯·æ±‚æ ¼å¼ï¼š{\\\"userId\\\": \\\"ç”¨æˆ·ID\\\", \\\"message\\\": \\\"æ¶ˆæ¯å†…å®¹\\\"}');\n}\n\nif (!userId) {\n  throw new Error('ç¼ºå°‘å¿…è¦å‚æ•°ï¼šuserIdã€‚è¯·æä¾›ç”¨æˆ·æ ‡è¯†ç¬¦');\n}\n\nif (!message) {\n  throw new Error('ç¼ºå°‘å¿…è¦å‚æ•°ï¼šmessageã€‚è¯·æä¾›æ¶ˆæ¯å†…å®¹');\n}\n\n// å‚æ•°æ¸…ç†å’ŒéªŒè¯\nconst cleanedUserId = userId.toString().trim();\nconst cleanedMessage = message.toString().trim();\nconst cleanedSessionId = sessionId.toString().trim();\n\nif (!cleanedUserId) {\n  throw new Error('userId å‚æ•°æ— æ•ˆï¼šä¸èƒ½ä¸ºç©ºæˆ–åªåŒ…å«ç©ºç™½å­—ç¬¦');\n}\n\nif (!cleanedMessage) {\n  throw new Error('message å‚æ•°æ— æ•ˆï¼šä¸èƒ½ä¸ºç©ºæˆ–åªåŒ…å«ç©ºç™½å­—ç¬¦');\n}\n\nconsole.log('=== å‚æ•°éªŒè¯é€šè¿‡ ===');\nconsole.log('æ¸…ç†åçš„å‚æ•°:', { \n  userId: cleanedUserId, \n  message: cleanedMessage, \n  sessionId: cleanedSessionId \n});\n\n// è¿”å›å¤„ç†åçš„æ•°æ®\nreturn {\n  userId: cleanedUserId,\n  message: cleanedMessage,\n  sessionId: cleanedSessionId,\n  timestamp: new Date().toISOString(),\n  _debug: {\n    inputReceived: !!$input.first(),\n    jsonParsed: !!inputData,\n    validationPassed: true\n  }\n};"
      },
      "id": "2",
      "name": "è§£æç”¨æˆ·è¾“å…¥",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// æ£€æŸ¥æ˜¯å¦ä¸ºåŒ¿åç”¨æˆ·\nconst currentSession = $input.first().json;\nconst isAnonymousUser = currentSession.userId.startsWith('anonymous_');\n\nconsole.log('ç”¨æˆ·ç±»å‹:', isAnonymousUser ? 'åŒ¿åç”¨æˆ·' : 'è®¤è¯ç”¨æˆ·');\nconsole.log('ç”¨æˆ·ID:', currentSession.userId);\n\nlet userData = {};\nlet projectsData = [];\n\nif (isAnonymousUser) {\n  // åŒ¿åç”¨æˆ·å¤„ç†\n  userData = {\n    id: currentSession.userId,\n    name: 'è®¿å®¢ç”¨æˆ·',\n    email: '',\n    preferences: {}\n  };\n  projectsData = [];\n} else {\n  // è®¤è¯ç”¨æˆ·å¤„ç†\n  try {\n    userData = $input.all()[0].json;\n    projectsData = $input.all()[1].json;\n  } catch (error) {\n    console.log('æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', error.message);\n    userData = {\n      id: currentSession.userId,\n      name: 'ç”¨æˆ·',\n      email: '',\n      preferences: {}\n    };\n    projectsData = [];\n  }\n}\n\nconst context = {\n  user: {\n    id: userData.id,\n    name: userData.name,\n    email: userData.email,\n    preferences: userData.preferences || {}\n  },\n  projects: projectsData.map(project => ({\n    id: project.id,\n    name: project.name,\n    description: project.description,\n    status: project.status,\n    knowledgeBase: project.knowledge_base || [],\n    tasks: project.tasks || []\n  })),\n  currentSession: currentSession,\n  isAnonymous: isAnonymousUser\n};\n\nconsole.log('æ„å»ºçš„ä¸Šä¸‹æ–‡:', {\n  userId: context.user.id,\n  userName: context.user.name,\n  projectCount: context.projects.length,\n  isAnonymous: context.isAnonymous\n});\n\nreturn context;"
      },
      "id": "3",
      "name": "æ„å»ºä¸Šä¸‹æ–‡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "const context = $input.first().json;\nconst isAnonymous = context.isAnonymous;\n\nconsole.log('AIå“åº” - ç”¨æˆ·ç±»å‹:', isAnonymous ? 'åŒ¿åç”¨æˆ·' : 'è®¤è¯ç”¨æˆ·');\n\n// æ ¹æ®ç”¨æˆ·ç±»å‹æä¾›ä¸åŒçš„å“åº”\nconst responses = {\n  'ä½ å¥½': isAnonymous ? \n    'æ‚¨å¥½ï¼æ¬¢è¿ä½¿ç”¨AIåŠ©æ‰‹ã€‚æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨è§£ç­”é—®é¢˜ã€æä¾›ä¿¡æ¯ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ' :\n    'æ‚¨å¥½ï¼æˆ‘æ˜¯AIé¡¹ç›®åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚æˆ‘å¯ä»¥å¸®æ‚¨ç®¡ç†é¡¹ç›®ã€æŸ¥è¯¢ä»»åŠ¡å’ŒçŸ¥è¯†åº“ã€‚',\n  'hello': isAnonymous ?\n    'Hello! Welcome to AI Assistant. I can help answer your questions and provide information. How can I assist you today?' :\n    'Hello! I am your AI project assistant. How can I help you today?',\n  'å—¨': isAnonymous ?\n    'å—¨ï¼æ¬¢è¿ä½¿ç”¨AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ' :\n    'å—¨ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ',\n  'é¡¹ç›®': isAnonymous ?\n    'æˆ‘æ˜¯é€šç”¨AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨è§£ç­”å„ç§é—®é¢˜ã€‚å¦‚æœæ‚¨éœ€è¦é¡¹ç›®ç®¡ç†åŠŸèƒ½ï¼Œå»ºè®®æ‚¨ç™»å½•è´¦æˆ·ä»¥è·å¾—å®Œæ•´åŠŸèƒ½ã€‚' :\n    'è®©æˆ‘å¸®æ‚¨æŸ¥çœ‹é¡¹ç›®ä¿¡æ¯...æ‚¨å¯ä»¥è¯´ï¼šæŸ¥çœ‹æˆ‘çš„é¡¹ç›®ã€åˆ›å»ºæ–°é¡¹ç›®ã€é¡¹ç›®è¿›åº¦å¦‚ä½•',\n  'project': isAnonymous ?\n    'I am a general AI assistant. For project management features, please log in to access full functionality.' :\n    'I can help you with project management. You can ask: Show my projects, Create new project, Project status',\n  'ä»»åŠ¡': isAnonymous ?\n    'æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”å„ç§é—®é¢˜ã€‚å¦‚éœ€ä»»åŠ¡ç®¡ç†åŠŸèƒ½ï¼Œå»ºè®®ç™»å½•è´¦æˆ·ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚' :\n    'æ‚¨æƒ³äº†è§£å“ªä¸ªé¡¹ç›®çš„ä»»åŠ¡ï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨ï¼šæŸ¥çœ‹å¾…åŠä»»åŠ¡ã€åˆ›å»ºæ–°ä»»åŠ¡ã€æ›´æ–°ä»»åŠ¡çŠ¶æ€',\n  'task': isAnonymous ?\n    'I can help answer your questions. For task management features, please log in.' :\n    'Which project tasks would you like to see? I can help you: View pending tasks, Create new tasks, Update task status',\n  'çŸ¥è¯†åº“': isAnonymous ?\n    'æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä¿¡æ¯å’Œè§£ç­”é—®é¢˜ã€‚å¦‚éœ€è®¿é—®çŸ¥è¯†åº“ï¼Œå»ºè®®ç™»å½•è´¦æˆ·ã€‚' :\n    'æ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢çŸ¥è¯†åº“å†…å®¹...æ‚¨å¯ä»¥è¯´ï¼šæœç´¢çŸ¥è¯†åº“ã€æ·»åŠ çŸ¥è¯†æ¡ç›®ã€å­¦ä¹ èµ„æ–™',\n  'knowledge': isAnonymous ?\n    'I can provide information and answer questions. For knowledge base access, please log in.' :\n    'Let me search the knowledge base for you. You can ask: Search knowledge, Add knowledge item, Learning materials',\n  'å¸®åŠ©': isAnonymous ?\n    'æˆ‘å¯ä»¥å¸®æ‚¨ï¼šè§£ç­”é—®é¢˜ã€æä¾›ä¿¡æ¯ã€ç®€å•å’¨è¯¢ã€‚å¦‚éœ€é¡¹ç›®ç®¡ç†ç­‰é«˜çº§åŠŸèƒ½ï¼Œå»ºè®®ç™»å½•è´¦æˆ·ã€‚' :\n    'æˆ‘å¯ä»¥å¸®æ‚¨ï¼šé¡¹ç›®ç®¡ç†ã€ä»»åŠ¡è·Ÿè¸ªã€çŸ¥è¯†åº“æŸ¥è¯¢ã€æ™ºèƒ½å»ºè®®ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ',\n  'help': isAnonymous ?\n    'I can help you: Answer questions, Provide information, General consultation. For advanced features like project management, please log in.' :\n    'I can help you with: Project Management, Task Tracking, Knowledge Base, Smart Suggestions. What do you need help with?',\n  'default': isAnonymous ?\n    `æˆ‘å·²ç»æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼š\"${context.currentSession.message}\"ã€‚ä½œä¸ºAIåŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”é—®é¢˜ã€æä¾›ä¿¡æ¯ã€‚å¦‚æœæ‚¨éœ€è¦é¡¹ç›®ç®¡ç†ç­‰é«˜çº§åŠŸèƒ½ï¼Œå»ºè®®ç™»å½•è´¦æˆ·ä»¥è·å¾—å®Œæ•´ä½“éªŒã€‚` :\n    `æˆ‘å·²ç»æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼š\"${context.currentSession.message}\"ã€‚ç›®å‰æˆ‘è¿˜åœ¨å­¦ä¹ é˜¶æ®µï¼Œä½†æˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨ç®¡ç†é¡¹ç›®ä¿¡æ¯ã€è·Ÿè¸ªä»»åŠ¡è¿›åº¦ã€æŸ¥è¯¢çŸ¥è¯†åº“å†…å®¹ã€æä¾›é¡¹ç›®å»ºè®®ã€‚æ‚¨å¯ä»¥è¯´ï¼šæŸ¥çœ‹æˆ‘çš„é¡¹ç›®ã€åˆ›å»ºæ–°ä»»åŠ¡ã€çŸ¥è¯†åº“æœç´¢ã€é¡¹ç›®è¿›åº¦æŠ¥å‘Š`\n};\n\nconst lowerMessage = context.currentSession.message.toLowerCase();\nlet response = responses.default;\n\nfor (const [key, value] of Object.entries(responses)) {\n  if (lowerMessage.includes(key.toLowerCase()) && key !== 'default') {\n    response = value;\n    break;\n  }\n}\n\n// ä¸ºè®¤è¯ç”¨æˆ·æ·»åŠ é¡¹ç›®ä¿¡æ¯\nif (!isAnonymous && context.projects && context.projects.length > 0) {\n  response += `\\n\\næ‚¨å½“å‰æœ‰ ${context.projects.length} ä¸ªé¡¹ç›®ï¼š`;\n  context.projects.slice(0, 3).forEach(project => {\n    response += `\\nâ€¢ ${project.name} (${project.status})`;\n  });\n  if (context.projects.length > 3) {\n    response += `\\nâ€¢ ...è¿˜æœ‰ ${context.projects.length - 3} ä¸ªé¡¹ç›®`;\n  }\n}\n\n// ä¸ºåŒ¿åç”¨æˆ·æ·»åŠ ç™»å½•æç¤º\nif (isAnonymous && (lowerMessage.includes('é¡¹ç›®') || lowerMessage.includes('ä»»åŠ¡') || lowerMessage.includes('çŸ¥è¯†åº“'))) {\n  response += '\\n\\nğŸ’¡ æç¤ºï¼šç™»å½•è´¦æˆ·å¯ä»¥è§£é”å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬é¡¹ç›®ç®¡ç†ã€ä»»åŠ¡è·Ÿè¸ªç­‰ã€‚';\n}\n\nreturn {\n  success: true,\n  response: {\n    message: response,\n    sessionId: context.currentSession.sessionId,\n    timestamp: new Date().toISOString(),\n    context: {\n      userId: context.user.id,\n      projectCount: context.projects ? context.projects.length : 0,\n      isAnonymous: isAnonymous\n    }\n  }\n};"
      },
      "id": "4",
      "name": "æ¨¡æ‹ŸAIå“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [920, 300]
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.first().json;\nreturn aiResponse;"
      },
      "id": "5",
      "name": "å¤„ç†AIå“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1160, 300]
    },
    {
      "parameters": {
        "operation": "insertRow",
        "schema": "public",
        "table": "chat_sessions",
        "additionalFields": {\n          "columns": "user_id, session_id, user_message, ai_response, created_at, is_anonymous"\n        },\n        "values": "={{ $json.user.id }}, {{ $json.response.sessionId }}, {{ $json.context.currentSession.message }}, {{ $json.response.message }}, {{ $json.response.timestamp }}, {{ $json.response.context.isAnonymous }}"
      },
      "id": "6",
      "name": "ä¿å­˜èŠå¤©è®°å½•",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1400, 300],
      "credentials": {\n        "postgres": "supabase-connection"\n      }
    },
    {
      "parameters": {\n        "mode": "lastNode"\n      },\n      "id": "7",
      "name": "è¿”å›å“åº”",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1620, 300]
    },\n    {\n      "parameters": {\n        "jsCode": "const error = $input.first().json;\\nreturn {\\n  success: false,\\n  error: {\\n    message: error.message || 'å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯',\\n    code: error.code || 'UNKNOWN_ERROR',\\n    timestamp: new Date().toISOString()\\n  }\\n};"\n      },\n      "id": "8",\n      "name": "é”™è¯¯å¤„ç†",\n      "type": "n8n-nodes-base.code",\n      "typeVersion": 2,\n      "position": [920, 500]\n    }\n  ],\n  "connections": {\n    "Webhook": {\n      "main": [\n        [\n          {\n            "node": "è§£æç”¨æˆ·è¾“å…¥",\n            "type": "main",\n            "index": 0\n          }\n        ]\n      ]\n    },\n    "è§£æç”¨æˆ·è¾“å…¥": {\n      "main": [\n        [\n          {\n            "node": "æ„å»ºä¸Šä¸‹æ–‡",\n            "type": "main",\n            "index": 0\n          }\n        ]\n      ]\n    },\n    "æ„å»ºä¸Šä¸‹æ–‡": {\n      "main": [\n        [\n          {\n            "node": "æ¨¡æ‹ŸAIå“åº”",\n            "type": "main",\n            "index": 0\n          }\n        ]\n      ]\n    },\n    "æ¨¡æ‹ŸAIå“åº”": {\n      "main": [\n        [\n          {\n            "node": "å¤„ç†AIå“åº”",\n            "type": "main",\n            "index": 0\n          }\n        ]\n      ],\n      "error": [\n        [\n          {\n            "node": "é”™è¯¯å¤„ç†",\n            "type": "main",\n            "index": 0\n          }\n        ]\n      ]\n    },\n    "å¤„ç†AIå“åº”": {\n      "main": [\n        [\n          {\n            "node": "ä¿å­˜èŠå¤©è®°å½•",\n            "type": "main",\n            "index": 0\n          }\n        ]\n      ]\n    },\n    "ä¿å­˜èŠå¤©è®°å½•": {\n      "main": [\n        [\n          {\n            "node": "è¿”å›å“åº”",\n            "type": "main",\n            "index": 0\n          }\n        ]\n      ]\n    },\n    "é”™è¯¯å¤„ç†": {\n      "main": [\n        [\n          {\n            "node": "è¿”å›å“åº”",\n            "type": "main",\n            "index": 0\n          }\n        ]\n      ]\n    }\n  },\n  "pinData": {},\n  "settings": {\n    "executionOrder": "v1"\n  },\n  "staticData": null,\n  "tags": [],\n  "triggerCount": 0,\n  "updatedAt": "2024-01-01T00:00:00.000Z",\n  "versionId": "1"\n}