{
  "name": "AI Project Assistant Workflow",
  "nodes": [
    {
      "parameters": {
        "path": "/webhook/ai-assistant",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-1",
      "name": "AI Assistant Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "ai-assistant-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "userId-check",
              "leftValue": "={{ $json.userId }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-2",
      "name": "Check User ID",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [480, 300]
    },
    {
      "parameters": {
        "functionCode": "const inputData = $input.first().json;\nif (!inputData.userId || !inputData.message) {\n  throw new Error('Missing required fields: userId and message');\n}\nconst processedData = {\n  userId: inputData.userId.toString().trim(),\n  message: inputData.message.toString().trim(),\n  sessionId: inputData.sessionId ? inputData.sessionId.toString().trim() : `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n  timestamp: new Date().toISOString(),\n  context: inputData.context || {}\n};\nreturn [processedData];"
      },
      "id": "function-3",
      "name": "Parse User Input",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [720, 300]
    },
    {
      "parameters": {
        "functionCode": "const session = $input.first().json;\nconst isAnonymous = session.userId.startsWith('anonymous_');\nconst context = {\n  user: {\n    id: session.userId,\n    type: isAnonymous ? 'anonymous' : 'authenticated',\n    name: isAnonymous ? 'Guest User' : 'Authenticated User',\n    isAnonymous: isAnonymous\n  },\n  session: {\n    id: session.sessionId,\n    timestamp: session.timestamp\n  },\n  message: session.message,\n  intent: analyzeIntent(session.message)\n};\nfunction analyzeIntent(message) {\n  const lowerMessage = message.toLowerCase();\n  if (lowerMessage.includes('project')) return 'project_management';\n  if (lowerMessage.includes('task') || lowerMessage.includes('todo')) return 'task_management';\n  if (lowerMessage.includes('knowledge') || lowerMessage.includes('learn')) return 'knowledge_query';\n  if (lowerMessage.includes('help')) return 'help_request';\n  if (lowerMessage.includes('create') || lowerMessage.includes('add')) return 'create_request';\n  if (lowerMessage.includes('query') || lowerMessage.includes('search')) return 'query_request';\n  return 'general_conversation';\n}\nreturn [context];"
      },
      "id": "function-4",
      "name": "Build User Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [960, 300]
    },
    {
      "parameters": {
        "url": "{{ $env.SUPABASE_URL }}/rest/v1/projects?user_id=eq.{{ $json.user.id }}&select=*",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "http-5",
      "name": "Fetch User Projects",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1200, 200]
    },
    {
      "parameters": {
        "url": "{{ $env.SUPABASE_URL }}/rest/v1/chat_sessions?user_id=eq.{{ $json.user.id }}&order=created_at.desc&limit=10&select=*",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "http-6",
      "name": "Fetch Chat History",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "functionCode": "const context = $input.first().json;\nconst projectsResponse = $input.all()[1];\nconst chatHistoryResponse = $input.all()[2];\nlet projects = [];\nif (projectsResponse && projectsResponse.json) {\n  projects = Array.isArray(projectsResponse.json) ? projectsResponse.json : [projectsResponse.json];\n}\nlet chatHistory = [];\nif (chatHistoryResponse && chatHistoryResponse.json) {\n  chatHistory = Array.isArray(chatHistoryResponse.json) ? chatHistoryResponse.json : [chatHistoryResponse.json];\n}\nconst enhancedContext = {\n  ...context,\n  data: {\n    projects: projects,\n    chatHistory: chatHistory.slice(0, 5),\n    projectCount: projects.length,\n    hasProjects: projects.length > 0\n  }\n};\nreturn [enhancedContext];"
      },
      "id": "function-7",
      "name": "Process Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1440, 300]
    },
    {
      "parameters": {
        "functionCode": "const context = $input.first().json;\nlet responseMessage = '';\nswitch (context.intent) {\n  case 'project_management':\n    if (context.data.projects.length === 0) {\n      responseMessage = \"æ‚¨ç›®å‰è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•é¡¹ç›®ã€‚æˆ‘å¯ä»¥å¸®æ‚¨ï¼š\\\\nâ€¢ åˆ›å»ºæ–°é¡¹ç›®\\\\nâ€¢ äº†è§£å¦‚ä½•å¼€å§‹é¡¹ç›®ç®¡ç†\\\\n\\\\næ‚¨æƒ³åˆ›å»ºç¬¬ä¸€ä¸ªé¡¹ç›®å—ï¼Ÿ\";\n    } else {\n      responseMessage = `æ‚¨æœ‰ ${context.data.projects.length} ä¸ªé¡¹ç›®ã€‚æˆ‘å¯ä»¥å¸®æ‚¨ç®¡ç†è¿™äº›é¡¹ç›®ã€‚`;\n    }\n    break;\n  case 'task_management':\n    responseMessage = \"æˆ‘å¯ä»¥å¸®æ‚¨ç®¡ç†ä»»åŠ¡ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³æ“ä½œå“ªä¸ªé¡¹ç›®çš„ä»»åŠ¡ï¼Ÿ\";\n    break;\n  case 'knowledge_query':\n    responseMessage = \"æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥è¯¢çŸ¥è¯†åº“ã€‚æ‚¨æƒ³æŸ¥è¯¢å“ªä¸ªé¡¹ç›®çš„çŸ¥è¯†åº“ï¼Ÿ\";\n    break;\n  case 'help_request':\n    responseMessage = \"æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®åŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨ï¼š\\\\n\\\\nğŸ“ é¡¹ç›®ç®¡ç†\\\\nâœ… ä»»åŠ¡ç®¡ç†\\\\nğŸ“š çŸ¥è¯†åº“æŸ¥è¯¢\\\\nğŸ’¡ å­¦ä¹ å»ºè®®\\\\n\\\\nè¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ\";\n    break;\n  default:\n    responseMessage = `æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®åŠ©æ‰‹ã€‚${context.data.hasProjects ? `æˆ‘çœ‹åˆ°æ‚¨æœ‰ ${context.data.projectCount} ä¸ªé¡¹ç›®ã€‚` : 'æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºé¡¹ç›®ã€‚'} æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`;\n}\nconst response = {\n  success: true,\n  response: {\n    message: responseMessage,\n    sessionId: context.session.id,\n    timestamp: new Date().toISOString(),\n    context: {\n      intent: context.intent,\n      hasProjects: context.data.hasProjects,\n      projectCount: context.data.projectCount\n    }\n  }\n};\nreturn [response];"
      },
      "id": "function-8",
      "name": "Generate AI Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1680, 300]
    },
    {
      "parameters": {
        "url": "{{ $env.SUPABASE_URL }}/rest/v1/chat_sessions",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ $json.context.user.id }}"
            },
            {
              "name": "session_id",
              "value": "={{ $json.response.sessionId }}"
            },
            {
              "name": "user_message",
              "value": "={{ $json.context.message }}"
            },
            {
              "name": "ai_response",
              "value": "={{ $json.response.message }}"
            },
            {
              "name": "context",
              "value": "={{ $json.response.context }}"
            },
            {
              "name": "is_anonymous",
              "value": "={{ $json.context.user.isAnonymous }}"
            }
          ]
        },
        "options": {}
      },
      "id": "http-9",
      "name": "Save Chat History",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1920, 300]
    },
    {
      "parameters": {
        "mode": "lastNode"
      },
      "id": "noop-10",
      "name": "Return Response",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2160, 300]
    },
    {
      "parameters": {
        "functionCode": "const errorResponse = {\n  success: false,\n  error: {\n    code: \"MISSING_USER_ID\",\n    message: \"ç”¨æˆ·IDä¸èƒ½ä¸ºç©º\",\n    details: \"è¯·æä¾›æœ‰æ•ˆçš„ç”¨æˆ·IDä»¥ç»§ç»­ä½¿ç”¨AIåŠ©æ‰‹æœåŠ¡\"\n  }\n};\nreturn [errorResponse];"
      },
      "id": "function-11",
      "name": "Error Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [480, 500]
    }
  ],
  "connections": {
    "AI Assistant Webhook": {
      "main": [
        [
          {
            "node": "Check User ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check User ID": {
      "main": [
        [
          {
            "node": "Parse User Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse User Input": {
      "main": [
        [
          {
            "node": "Build User Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build User Context": {
      "main": [
        [
          {
            "node": "Fetch User Projects",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Chat History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch User Projects": {
      "main": [
        [
          {
            "node": "Process Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Chat History": {
      "main": [
        [
          {
            "node": "Process Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Data": {
      "main": [
        [
          {
            "node": "Generate AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate AI Response": {
      "main": [
        [
          {
            "node": "Save Chat History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Chat History": {
      "main": [
        [
          {
            "node": "Return Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Response": {
      "main": [
        [
          {
            "node": "Return Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}