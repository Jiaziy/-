import { supabase } from '../lib/supabase'

// 模拟数据API（备用数据）
const poemsData = [
  {
    id: 1,
    title: '静夜思',
    author: '李白',
    dynasty: '唐朝',
    content: '床前明月光，疑是地上霜。举头望明月，低头思故乡。',
    lines: [
      '床前明月光',
      '疑是地上霜',
      '举头望明月',
      '低头思故乡'
    ],
    translation: '明亮的月光洒在窗户纸上，好像地上泛起了一层霜。我禁不住抬起头来，看那天窗外空中的一轮明月，不由得低头沉思，想起远方的家乡。',
    notes: '静夜思：宁静的夜晚产生的思绪。疑：好像。举头：抬头。',
    appreciation: '这首诗写的是在寂静的月夜思念家乡的感受。诗的前两句，是写诗人在作客他乡的特定环境中一刹那间所产生的错觉。后两句通过动作神态的刻画，深化思乡之情。'
  },
  {
    id: 2,
    title: '春望',
    author: '杜甫',
    dynasty: '唐朝',
    content: '国破山河在，城春草木深。感时花溅泪，恨别鸟惊心。烽火连三月，家书抵万金。白头搔更短，浑欲不胜簪。',
    lines: [
      '国破山河在',
      '城春草木深',
      '感时花溅泪',
      '恨别鸟惊心',
      '烽火连三月',
      '家书抵万金',
      '白头搔更短',
      '浑欲不胜簪'
    ],
    translation: '长安沦陷，国家破碎，只有山河依旧；春天来了，人烟稀少的长安城里草木茂密。感伤国事，不禁涕泪四溅，鸟鸣惊心，徒增离愁别恨。连绵的战火已经延续了半年多，家书难得，一封抵得上万两黄金。愁绪缠绕，搔头思考，白发越搔越短，简直要不能插簪了。',
    notes: '国：国都，指长安。破：陷落。山河在：旧日的山河仍然存在。城：长安城。草木深：指人烟稀少。感时：为国家的时局而感伤。溅泪：流泪。恨别：怅恨离别。烽火：古时边防报警的烟火，这里指安史之乱的战火。三月：正月、二月、三月。抵：值，相当。白头：这里指白头发。搔：用手指轻轻的抓。浑：简直。欲：想，要。不胜：受不住，不能。簪：一种束发的首饰。',
    appreciation: '这首诗全篇情景交融，感情深沉，而又含蓄凝练，言简意赅，充分体现了“沉郁顿挫”的艺术风格。且这首诗结构紧凑，围绕“望”字展开，前四句借景抒情，情景结合。诗人由登高远望到焦点式的透视，由远及近，感情由弱到强，就在这感情和景色的交叉转换中含蓄地传达出诗人的感叹忧愤。'
  },
  {
    id: 3,
    title: '水调歌头·明月几时有',
    author: '苏轼',
    dynasty: '宋朝',
    content: '明月几时有？把酒问青天。不知天上宫阙，今夕是何年。我欲乘风归去，又恐琼楼玉宇，高处不胜寒。起舞弄清影，何似在人间。转朱阁，低绮户，照无眠。不应有恨，何事长向别时圆？人有悲欢离合，月有阴晴圆缺，此事古难全。但愿人长久，千里共婵娟。',
    lines: [
      '明月几时有？把酒问青天。',
      '不知天上宫阙，今夕是何年。',
      '我欲乘风归去，又恐琼楼玉宇，高处不胜寒。',
      '起舞弄清影，何似在人间。',
      '转朱阁，低绮户，照无眠。',
      '不应有恨，何事长向别时圆？',
      '人有悲欢离合，月有阴晴圆缺，此事古难全。',
      '但愿人长久，千里共婵娟。'
    ],
    translation: '明月从什么时候才开始出现的？我端起酒杯遥问苍天。不知道在天上的宫殿，何年何月。我想要乘御清风回到天上，又恐怕在美玉砌成的楼宇，受不住高耸九天的寒冷。翩翩起舞玩赏着月下清影，哪像是在人间。月儿转过朱红色的楼阁，低低地挂在雕花的窗户上，照着没有睡意的自己。明月不该对人们有什么怨恨吧，为什么偏在人们离别时才圆呢？人有悲欢离合的变迁，月有阴晴圆缺的转换，这种事自古来难以周全。只希望这世上所有人的亲人能平安健康，即便相隔千里，也能共享这美好的月光。',
    notes: '水调歌头：词牌名。丙辰：指公元1076年（宋神宗熙宁九年）。子由：苏轼的弟弟苏辙的字。把酒：端起酒杯。把，执、持。天上宫阙（què）：指月中宫殿。阙，古代城墙后的石台。归去：回去，这里指回到月宫里去。琼（qióng）楼玉宇：美玉砌成的楼宇，指想象中的仙宫。不胜（shèng）：经受不住。胜：承担、承受。弄清影：意思是月光下的身影也跟着做出各种舞姿。弄：赏玩。何似：何如，哪里比得上。转朱阁，低绮（qǐ）户，照无眠：月儿移动，转过了朱红色的楼阁，低低地挂在雕花的窗户上，照着没有睡意的人（指诗人自己）。朱阁：朱红的华丽楼阁。绮户：雕饰华丽的门窗。不应有恨，何事长（cháng）向别时圆：（月儿）不该（对人们）有什么怨恨吧，为什么偏在人们分离时圆呢？何事：为什么。此事：指人的“欢”“合” 和月的“晴”“圆”。但：只。共：一起欣赏。婵娟：指月亮。',
    appreciation: '此词是中秋望月怀人之作，表达了对胞弟苏辙的无限怀念。词人运用形象描绘手法，勾勒出一种皓月当空、亲人千里、孤高旷远的境界氛围，反衬自己遗世独立的意绪和往昔的神话传说融合一处，在月的阴晴圆缺当中，渗进浓厚的哲学意味，可以说是一首将自然和社会高度契合的感喟作品。'
  },
  {
    id: 4,
    title: '青玉案·元夕',
    author: '辛弃疾',
    dynasty: '宋朝',
    content: '东风夜放花千树，更吹落、星如雨。宝马雕车香满路。凤箫声动，玉壶光转，一夜鱼龙舞。蛾儿雪柳黄金缕，笑语盈盈暗香去。众里寻他千百度，蓦然回首，那人却在，灯火阑珊处。',
    lines: [
      '东风夜放花千树，更吹落、星如雨。',
      '宝马雕车香满路。',
      '凤箫声动，玉壶光转，一夜鱼龙舞。',
      '蛾儿雪柳黄金缕，笑语盈盈暗香去。',
      '众里寻他千百度，蓦然回首，那人却在，灯火阑珊处。'
    ],
    translation: '像东风吹散千树繁花一样，又吹得烟火纷纷，乱落如雨。豪华的马车满路芳香。悠扬的凤箫声四处回荡，玉壶般的明月渐渐西斜，一夜鱼龙灯飞舞笑语喧哗。美人头上都戴着亮丽的饰物，笑语盈盈地随人群走过，身上香气飘洒。我在人群中寻找她千百回，猛然一回头，不经意间却在灯火零落之处发现了她。',
    notes: '青玉案：词牌名。“案”读wan，第三声，与“碗”同音。元夕：夏历正月十五日为上元节，元宵节，此夜称元夕或元夜。花千树：花灯之多如千树开花。星如雨：指焰火纷纷，乱落如雨。星，指焰火。形容满天的烟花。宝马雕车：豪华的马车。凤箫：箫的美称。玉壶：比喻明月。亦可解释为指灯。鱼龙舞：指舞动鱼形、龙形的彩灯，如鱼龙闹海一样。蛾儿、雪柳、黄金缕：皆古代妇女元宵节时头上佩戴的各种装饰品。这里指盛装的妇女。盈盈：声音轻盈悦耳，亦指仪态娇美的样子。暗香：本指花香，此指女性们身上散发出来的香气。他：泛指，当时就包括了“她”。千百度：千百遍。蓦然：突然，猛然。阑珊：零落稀疏的样子。',
    appreciation: '这首词的上半阕写正月十五的晚上，满城灯火，尽情狂欢的景象。下半阕仍然在写“元夕”的欢乐，且一对意中人在大街巧遇的场景。只不过上阕写的是整个场面，下阕写一个具体的人，通过他一波三折的感情起伏，把个人的欢乐自然地融进了节日的欢乐之中。'
  },
  {
    id: 5,
    title: '声声慢·寻寻觅觅',
    author: '李清照',
    dynasty: '宋朝',
    content: '寻寻觅觅，冷冷清清，凄凄惨惨戚戚。乍暖还寒时候，最难将息。三杯两盏淡酒，怎敌他、晚来风急？雁过也，正伤心，却是旧时相识。满地黄花堆积。憔悴损，如今有谁堪摘？守着窗儿，独自怎生得黑？梧桐更兼细雨，到黄昏、点点滴滴。这次第，怎一个愁字了得！',
    lines: [
      '寻寻觅觅，冷冷清清，凄凄惨惨戚戚。',
      '乍暖还寒时候，最难将息。',
      '三杯两盏淡酒，怎敌他、晚来风急？',
      '雁过也，正伤心，却是旧时相识。',
      '满地黄花堆积。憔悴损，如今有谁堪摘？',
      '守着窗儿，独自怎生得黑？',
      '梧桐更兼细雨，到黄昏、点点滴滴。',
      '这次第，怎一个愁字了得！'
    ],
    translation: '苦苦地寻寻觅觅，却只见冷冷清清，怎不让人凄惨悲戚。秋天总是忽然变暖，又转寒冷，最难保养休息。喝三杯两杯淡酒，怎么能抵得住傍晚的寒风紧吹？一行大雁从头顶上飞过，更让人伤心，因为都是当年为我传递书信的旧日相识。园中菊花堆积满地，都已经憔悴不堪，如今还有谁来采摘？孤独地守着窗前，独自一个人怎么熬到天黑？梧桐叶上细雨淋漓，到黄昏时分，那雨声还是点点滴滴。这般光景，怎么能用一个“愁”字了结！',
    notes: '寻寻觅觅：意谓想把失去的一切都找回来，表现非常空虚怅惘、迷茫失落的心态。凄凄惨惨戚戚：忧愁苦闷的样子。乍暖还（huán）寒：指秋天的天气，忽然变暖，又转寒冷。将息：旧时方言，休养调理之意。怎敌他：对付，抵挡。晚：一本作“晓”。损：表示程度极高。堪：可。怎生：怎样的。生：语助词。梧桐更兼细雨：暗用白居易《长恨歌》“秋雨梧桐叶落时”诗意。这次第：这光景、这情形。怎一个愁字了得：一个“愁”字怎么能概括得尽呢？',
    appreciation: '这首词起句便不寻常，一连用七组叠词。不但在填词方面，即使在诗赋曲也绝无仅有。但好处不仅在此，这七组叠词还极富音乐美。宋词是用来演唱的，因此音调和谐是一个很重要的内容。李清照对音律有极深造诣，所以这七组叠词朗读起来，便有一种大珠小珠落玉盘的感觉。'
  },
  {
    id: 6,
    title: '木兰词·拟古决绝词柬友',
    author: '纳兰性德',
    dynasty: '清朝',
    content: '人生若只如初见，何事秋风悲画扇。等闲变却故人心，却道故人心易变。骊山语罢清宵半，泪雨霖铃终不怨。何如薄幸锦衣郎，比翼连枝当日愿。',
    lines: [
      '人生若只如初见，何事秋风悲画扇。',
      '等闲变却故人心，却道故人心易变。',
      '骊山语罢清宵半，泪雨霖铃终不怨。',
      '何如薄幸锦衣郎，比翼连枝当日愿。'
    ],
    translation: '人生如果都像初次相遇那般相处该多美好，那样就不会有现在的离别相思凄凉之苦了。如今轻易地变了心，你却反而说情人间就是容易变心的。想当初唐皇与贵妃的山盟海誓犹在耳边，却又最终作决绝之别，即使如此，也生不得怨。但你又怎比得上当年的唐明皇呢，他总还是与杨玉环有过比翼鸟、连理枝的誓愿。',
    notes: '柬：给……信札。“何事”句：用汉朝班婕妤被弃的典故。班婕妤为汉成帝妃，被赵飞燕谗害，退居冷宫，后有诗《怨歌行》，以秋扇闲置为喻抒发被弃之怨情。南北朝梁刘孝绰《班婕妤怨》诗又点明“妾身似秋扇”，后遂以秋扇见捐喻女子被弃。这里是说本应当相亲相爱，但却成了相离相弃。故人：指情人。却道故人心易变（出自娱园本），一作“却道故心人易变”。骊山语罢清宵半，泪雨霖铃终不怨：用唐明皇与杨玉环的爱情典故。薄幸：薄情。锦衣郎：指唐明皇。',
    appreciation: '此词描写了一个为情所伤的女子和伤害她的男子坚决分手的情景，借用班婕妤被弃以及唐玄宗与杨贵妃的爱情悲剧的典故，通过“秋扇”、“骊山语”、“雨霖铃”、“比翼连枝”这些意象，营造了一种幽怨、凄楚、悲凉的意境，抒写了女子被男子抛弃的幽怨之情。'
  }
]

// 获取诗词列表
export async function getPoems(page = 1, perPage = 10) {
  try {
    // 尝试从Supabase获取数据
    const { data, error, count } = await supabase
      .from('poems')
      .select('*', { count: 'exact' })
      .range((page - 1) * perPage, page * perPage - 1)
      .order('id')

    if (error || !data || data.length === 0) {
      // 如果Supabase查询失败或没有数据，使用模拟数据
      console.warn('Supabase查询失败，使用模拟数据:', error?.message)
      const start = (page - 1) * perPage
      const end = start + perPage
      return {
        poems: poemsData.slice(start, end),
        total: poemsData.length
      }
    }

    return {
      poems: data,
      total: count || data.length
    }
  } catch (error) {
    console.error('获取诗词列表错误:', error)
    // 出错时使用模拟数据
    const start = (page - 1) * perPage
    const end = start + perPage
    return {
      poems: poemsData.slice(start, end),
      total: poemsData.length
    }
  }
}

// 根据ID获取诗词详情
export async function getPoemById(id) {
  try {
    const { data, error } = await supabase
      .from('poems')
      .select('*')
      .eq('id', Number(id))
      .single()

    if (error || !data) {
      console.warn('Supabase查询失败，使用模拟数据:', error?.message)
      return poemsData.find(poem => poem.id === Number(id))
    }

    return data
  } catch (error) {
    console.error('获取诗词详情错误:', error)
    return poemsData.find(poem => poem.id === Number(id))
  }
}

// 搜索诗词
export async function searchPoems(query) {
  if (!query) return []
  
  try {
    const { data, error } = await supabase
      .from('poems')
      .select('*')
      .or(`title.ilike.%${query}%,author.ilike.%${query}%,content.ilike.%${query}%`)

    if (error || !data || data.length === 0) {
      console.warn('Supabase搜索失败，使用模拟数据:', error?.message)
      const lowerQuery = query.toLowerCase()
      return poemsData.filter(poem => 
        poem.title.toLowerCase().includes(lowerQuery) ||
        poem.author.toLowerCase().includes(lowerQuery) ||
        poem.content.toLowerCase().includes(lowerQuery)
      )
    }

    return data
  } catch (error) {
    console.error('搜索诗词错误:', error)
    const lowerQuery = query.toLowerCase()
    return poemsData.filter(poem => 
      poem.title.toLowerCase().includes(lowerQuery) ||
      poem.author.toLowerCase().includes(lowerQuery) ||
      poem.content.toLowerCase().includes(lowerQuery)
    )
  }
}